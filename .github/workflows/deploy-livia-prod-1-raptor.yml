name: deploy-livia-prod-1-raptor

on:
  workflow_dispatch:
  workflow_run:
    workflows: [ build ]
    types: [ completed ]

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: livia-prod-1-uksouth

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy via SSH
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_ORG: ${{ secrets.GHCR_ORG }}
          IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} \
            "echo '${GHCR_TOKEN}' | docker login ghcr.io -u '${GHCR_USER}' --password-stdin && \
             docker pull ghcr.io/${GHCR_ORG}/${IMAGE_NAME}:latest && \
             docker stop livia || true && \
             docker rm livia || true && \
             docker run -d --name livia \
               --network livia_default \
               -p 2259:2259 \
               --env-file ~/livia/.env \
               -e SPRING_DATA_REDIS_HOST=redis \
               -e SPRING_DATA_REDIS_PORT=6379 \
               -e SPRING_DATA_MONGODB_HOST=mongo \
               -e SPRING_DATA_MONGODB_PORT=27017 \
               ghcr.io/${GHCR_ORG}/${IMAGE_NAME}:latest && \
             docker image prune -f && \
             docker ps | grep livia"
