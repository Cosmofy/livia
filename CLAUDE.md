# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Livia is a scalable, AI-augmented GraphQL backend powering the Cosmofy astronomy platform. It provides unified data access for planetary information, astronomy pictures, natural events, and curated articles across iOS/iPadOS, watchOS, tvOS, macOS, visionOS, and web platforms.

**Tech Stack**: Java 24, Spring Boot, Netflix DGS (GraphQL), Redis/Valkey caching, MongoDB, OpenAI GPT-5/5-Mini, Docker

**Production Endpoints**:
- Global DNS: `https://livia.arryan.xyz/graphql`
- GraphiQL Playground: `https://livia.arryan.xyz/graphiql`
- Multi-region deployment: London (Oracle ARM), Dallas (GCP x86), Singapore (AWS ARM)

## Commands

### Development
```bash
# Run the application locally (requires Java 24)
./gradlew bootRun

# Run with Docker Compose (includes Redis + MongoDB)
docker-compose up

# Build the project
./gradlew build

# Run tests
./gradlew test

# Generate GraphQL types from schema
./gradlew generateJava
```

### Environment Setup
Create a `.env` file with:
```
OPENAI_API_KEY=your_key_here
LIVIA_REGION=your_region
```

Spring Boot will also need Redis and MongoDB configuration via environment variables or application.properties:
- `SPRING_DATA_REDIS_HOST` / `SPRING_DATA_REDIS_PORT`
- `SPRING_DATA_MONGODB_HOST` / `SPRING_DATA_MONGODB_PORT`

## Architecture

### GraphQL Schema-First Design
The API is defined in `src/main/resources/schema/schema.graphqls`. The Netflix DGS Codegen plugin generates Java types from this schema into the `xyz.arryan.livia.codegen` package.

### Data Fetchers (Resolvers)
Each GraphQL query is implemented as a `@DgsComponent` with `@DgsQuery` methods in `src/main/java/xyz/arryan/livia/datafetchers/`:

- **PlanetsDataFetcher**: Loads static planetary data from MongoDB (primary) or `src/main/resources/planets.json` (fallback). Data was initially generated using AI (GPT-5-Mini) to parse NASA JPL Horizons API responses. Now stored statically for manual verification/editing via MongoDB Compass. Cached for 30 days in Redis.

- **PictureDataFetcher**: Retrieves NASA APOD (Astronomy Picture of the Day) with AI-generated summaries and kid-friendly explanations. Stored in MongoDB with day-end invalidation.

- **EventsDataFetcher**: Pulls natural disaster events from NASA EONET with geographic filtering. Cached for 1 hour in Redis.

- **ArticlesDataFetcher**: Serves curated monthly astronomy articles from `src/main/resources/articles.json`. Month-end invalidation.

### Caching Strategy
Redis caching is configured in `RedisConfig.java` with distinct TTLs:
- `planets`: 30 days
- `events`: 1 hour
- APOD pictures use MongoDB with custom invalidation logic

### Editing Planet Data
Planetary data is stored in MongoDB's `planets` collection (8 planets, ~50 fields each). Use **MongoDB Compass** for visual table editing:
1. Install MongoDB Compass: https://www.mongodb.com/try/download/compass
2. Connect to `mongodb://localhost:27017`
3. Navigate to `livia` database â†’ `planets` collection
4. Edit fields directly in table/document view
5. Changes are cached in Redis for 30 days - clear Redis cache to see updates immediately

### AI Integration (Historical)
The planet data was initially generated by fetching raw text from NASA JPL Horizons API and using OpenAI's GPT-5-Mini to parse it into structured JSON. This AI-generated data now lives statically in MongoDB/JSON and can be manually verified/corrected.

### Key Configuration
- **Virtual Threads**: Enabled for DGS (`dgs.graphql.virtualthreads.enabled=true`)
- **Logging**: DEBUG level for `xyz.arryan.livia` with colorized console output
- **Port**: 2259 (custom port)

### Deployment
Multi-cloud deployment via GitHub Actions:
- `build.yml`: Builds multi-arch Docker images (amd64/arm64) and pushes to GitHub Container Registry
- Region-specific workflows deploy to Oracle Cloud, GCP, and AWS
- DNS routing via AWS Route 53 with latency-based policies
